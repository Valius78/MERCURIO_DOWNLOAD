{% extends "base.html" %}

{% block title %}Scheduler – Viewer{% endblock %}

{% block content %}
<div class="container-fluid">

    <h3 class="mb-4">
        <i class="fas fa-eye"></i> Scheduler Acquisizioni – Viewer
    </h3>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Stato acquisizioni</span>
            
        </div>

        <div class="table-responsive">
            <table class="table table-hover mb-0" id="queueTable">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Item Code</th>
                        <th>Nome Acquisizione</th>
                        <th>Status</th>
                        <th>Err</th>
                        <th>Ritardo (s)</th>
                        <th>Da Fare</th>
                        <th>Reset</th>
                        <th>Type</th>
                        <th>Ultima Esecuzione / Min Data</th>
                        <th>Frequenza</th>
                    </tr>
                </thead>

                <tbody>
                {% for item in queue %}
                    {# Logica Cooldown: usiamo una tolleranza per il fuso orario se necessario #}
                    {% set is_cooldown = 
                        item.consecutive_failures >= 5 
                        and item.next_retry_at 
                        and item.next_retry_at > current_reference 
                    %}
                    
                    <tr class="
                        {% if is_cooldown %}table-warning
                        {% elif item.last_status == 'running' %}table-success
                        {% elif item.last_status == 'failed' %}table-danger
                        {% endif %}
                    ">
                        <td>{{ loop.index }}</td>
                        <td><strong>{{ item.item_code }}</strong></td>
                        <td>{{ item.acquisition_name }}</td>

                        <td>
                            {% if is_cooldown %}
                                {# Calcolo differenza totale in secondi #}
                                {% set diff_s = (item.next_retry_at - current_reference).total_seconds()|int %}
                                
                                {# Se il numero è enorme (es. > 1 ora), proviamo a sottrarre lo sfasamento di fuso orario (3600 o 7200s) #}
                                {% if diff_s > 3600 %}
                                    {% set diff_s = diff_s % 3600 %}
                                {% endif %}

                                {% set m = diff_s // 60 %}
                                {% set s = diff_s % 60 %}
                                
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-clock"></i> COOLDOWN {{ "%02d"|format(m) }}:{{ "%02d"|format(s) }}
                                </span>
                            {% else %}
                                <span class="badge
                                    {% if item.last_status == 'success' %}bg-primary
                                    {% elif item.last_status == 'failed' %}bg-danger
                                    {% elif item.last_status == 'running' %}bg-success
                                    {% else %}bg-secondary{% endif %}
                                ">
                                    {{ item.last_status|upper if item.last_status else 'IDLE' }}
                                </span>
                            {% endif %}
                        </td>

                        <td>
                            {% if item.consecutive_failures > 0 %}
                                <span class="badge bg-danger">{{ item.consecutive_failures }}</span>
                            {% else %}0{% endif %}
                        </td>

                        <td>{{ item.seconds_diff|round|int if item.seconds_diff else "N/A" }}</td>
                        <td>{{ "Sì" if item.active_and_late else "No" }}</td>
                        <td>{{ "Sì" if item.reset_requested else "No" }}</td>
                        <td>{{ item.schedule_type }}</td>

                        <td>
                            {% if item.last_execution %}
                                <div>{{ item.last_execution.strftime("%d/%m/%y %H:%M") }}</div>
                                {% if item.min_last_timestamp %}
                                    <div class="small text-danger fw-bold" style="font-size: 0.75rem;">
                                        Min Data: {{ item.min_last_timestamp.strftime("%d/%m/%y %H:%M") }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>

                        <td>
                            <small class="text-muted">
                                {{ item.frequency_seconds }}s<br>
                                
                            </small>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Refresh ogni 10 secondi per ricalcolare i tempi server-side
setInterval(() => { location.reload(); }, 10000);
</script>
{% endblock %}