{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #channelMap {
            height: 350px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .coordinate-input {
            font-family: monospace;
        }
    </style>
{% endblock %}


{% block title %}
{% if action == 'new' %}Canale{% else %}Canale{% endif %}
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>
            <i class="fas fa-{{ 'edit' if action == 'edit' else 'plus' }}"></i>
            Canale
        </h1>
        <p class="text-muted">
                Informazioni del canale di misurazione esistente
        </p>
    </div>
    <div class="col-auto">
        <div class="btn-group" role="group" aria-label="Azioni secondarie e lista">
            <a href="{{ url_for('channels.channels') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Torna alla Lista
            </a>
        </div>
    </div>
</div>

{% if not items %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Attenzione:</strong> Nessun Item disponibile. 
    <a href="{{ url_for('items.new_item') }}" class="alert-link">Crea prima un Item</a>.
</div>
{% endif %}

<form method="POST"  id="channelForm">
    
    {% if action == 'edit' %}
    <input type="hidden" name="channel_id" value="{{ channel.channel_id }}">
    {% endif %}

    <div class="row">
        <div class="col-md-12">
            <fieldset id="formFieldset">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informazioni Base</h5>
                </div>
                <div class="card-body">
                    
                    {% if action == 'edit' %}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-map"></i> Scenario
                                </label>
                                <input type="text" class="form-control" readonly style="background-color: #f8f9fa;" 
                                    value="{% if channel %}{{ channel.scenario_name }}{% if channel.scenario_code %} ({{ channel.scenario_code }}){% endif %}{% endif %}">
                                
                            </div>
    
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-map-marked-alt"></i> Area
                                </label>
                                <input type="text" class="form-control" readonly style="background-color: #f8f9fa;" 
                                    value="{% if channel %}{{ channel.area_name }}{% if channel.area_code %} ({{ channel.area_code }}){% endif %}{% endif %}">
                                
                            </div>
    
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-cube"></i> Item di Appartenenza
                                </label>
                                <input type="text" class="form-control" readonly style="background-color: #f8f9fa;" 
                                    value="{% if channel %}{{ channel.item_name }} ({{ channel.item_code }}){% endif %}">
                                <input type="hidden" name="item_id" value="{{ channel.item_id if channel else '' }}">
                                
                            </div>
                        </div>

					{% else %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="scenario_filter" class="form-label">
                                    <i class="fas fa-map"></i> Scenario 
                                </label>
                                <select id="scenario_filter" class="form-select" 
                                        onchange="updateAreasByScenarioChannel()" required>
                                    <option value="">-- Seleziona Scenario --</option>
                                    {% for scenario in scenarios %}
                                    <option value="{{ scenario.scenario_id }}">
                                        {{ scenario.name }} ({{ scenario.code }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Filtra per scenario</div>
                            </div>
    
                            <div class="col-md-6">
                                <label for="area_filter" class="form-label">
                                    <i class="fas fa-map-marked-alt"></i> Area 
                                </label>
                                <select id="area_filter" class="form-select" 
                                        onchange="updateItemsByAreaChannel()" required>
                                    <option value="">-- Prima seleziona Scenario --</option>
                                </select>
                                <div class="form-text">Filtra per area</div>
                            </div>
                        </div>
    
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="item_id" class="form-label">
                                    <i class="fas fa-cube"></i> Item di Appartenenza 
                                </label>
                                <select name="item_id" id="item_id" class="form-select" required onchange="inheritCoordinates()">
                                    <option value="">-- Prima seleziona Area --</option>
                                </select>
                                <div class="form-text">Item di appartenenza (filtrato)</div>
                            </div>
                        </div>
					{% endif %}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">
                                <i class="fas fa-tag"></i> Nome Canale 
                            </label>
                            <input type="text" name="name" id="name" class="form-control" 
                                   value="{{ channel.name if channel else '' }}" 
                                   required maxlength="200" 
                                   placeholder="es: Water Content 1, Battery Voltage">
                           
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="code" class="form-label">
                                <i class="fas fa-barcode"></i> Codice Canale 
                            </label>
                            {% if action == 'edit' %}
                            <input type="text" class="form-control" readonly style="background-color: #f8f9fa;" 
                                   value="{{ channel.code if channel else '' }}">
                            <input type="hidden" name="code" value="{{ channel.code if channel else '' }}">
                            
                            {% else %}
                            <div class="input-group">
                                <span class="input-group-text bg-light" id="itemCodePrefix">
                                    Seleziona Item-
                                </span>
                                
                                <input type="text" name="channel_suffix_alpha" id="channel_suffix_alpha" class="form-control" 
                                       required maxlength="5" 
                                       placeholder="TMP, INC, BAT..."
                                       style="text-transform: uppercase; max-width: 80px;">
                                
                                <span class="input-group-text">-</span>
                                
                                <input type="text" id="channel_number_display" class="form-control" 
                                       readonly style="background-color: #f8f9fa; max-width: 60px; text-align: center;"
                                       placeholder="01">

                                <button type="button" class="btn btn-outline-secondary" onclick="suggestChannelSuffix()" 
                                        title="Suggerisci codice automatico basato sul nome">
                                    <i class="fas fa-magic"></i> Suggerisci
                                </button>
                            </div>
                            
                            <input type="hidden" name="channel_suffix" id="channel_suffix">
                            <input type="hidden" name="code" id="code">
                            
                            <div class="form-text">
                                <strong>Suffisso:</strong> Solo parte alfabetica (es: TMP, INC, BAT). 
                                <strong>Numero:</strong> Generato automaticamente.
                            </div>
                            
                            <div id="existingSuffixes" class="mt-2" style="display: none;">
                                <small class="text-secondary">
                                    <strong>Suffissi piÃ¹ usati:</strong> 
                                    <span id="suffixesList" class="font-monospace text-dark bg-light px-2 py-1 rounded"></span>
                                </small>
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-toggle-on"></i> Stato Canale
                            </label>
                            <div class="form-check form-switch">
                                <input type="checkbox" name="status" id="status" class="form-check-input" 
                                       {% if not channel or channel.status %}checked{% endif %}>
                                <label for="status" class="form-check-label">Channel Attivo</label>
                            </div>
                            
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left"></i> Descrizione
                            </label>
                            <textarea name="description" id="description" class="form-control" rows="3" 
                                      placeholder="Descrizione dettagliata del channel, sensore, modalitÃ  di misurazione...">{{ channel.description if channel else '' }}</textarea>
                        </div>
                    </div>

                </div>
            </div> <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cogs"></i> Configurazione Misurazione</h5>
                </div>
                <div class="card-body">
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-signal"></i> ModalitÃ  Acquisizione
                            </label>
                            <input type="text" id="acquisition_type_display" class="form-control" readonly 
                                   style="background-color: #f8f9fa;">
                           
                            <input type="hidden" name="acquisition_type" id="acquisition_type">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6" id="frequencySection">
                            <label for="acq_frequency" class="form-label">
                                <i class="fas fa-clock"></i> Frequenza Acquisizione
                            </label>
                            <div class="input-group">
                                <input type="number" name="acq_frequency_value" id="acq_frequency_value" class="form-control" 
                                   value="{% if channel and channel.acq_frequency %}{{ channel.acq_frequency // 60 if channel.acq_frequency >= 60 else channel.acq_frequency }}{% endif %}" 
                                   min="1" placeholder="1">
                                <select name="acq_frequency_unit" id="acq_frequency_unit" class="form-select" style="max-width: 120px;">
                                    <option value="1" {% if channel and channel.acq_frequency and channel.acq_frequency < 60 %}selected{% endif %}>secondi</option>
                                    <option value="60" {% if channel and channel.acq_frequency and channel.acq_frequency >= 60 and channel.acq_frequency < 3600 %}selected{% endif %}>minuti</option>
                                    <option value="3600" {% if channel and channel.acq_frequency and channel.acq_frequency >= 3600 and channel.acq_frequency < 86400 %}selected{% endif %}>ore</option>
                                    <option value="86400" {% if channel and channel.acq_frequency and channel.acq_frequency >= 86400 %}selected{% endif %}>giorni</option>
                                </select>
                            </div>
                            <input type="hidden" name="acq_frequency" id="acq_frequency" value="{{ channel.acq_frequency if channel else '' }}">
                            <div class="form-text">Intervallo tra le acquisizioni</div>
                        </div>

                        <div class="col-md-6" id="dateSection" style="display: none;">
                            <label for="acquisition_date" class="form-label">
                                <i class="fas fa-calendar"></i> Data Acquisizione
                            </label>
                            <input type="date" name="acquisition_date" id="acquisition_date" class="form-control" 
                                   value="{{ channel.acquisition_date.strftime('%Y-%m-%d') if channel and channel.acquisition_date else '' }}">
                           
                        </div>
                    </div>
                    </fieldset>
                </div>
            </div> <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Posizione Geografica</h5>
                </div>
                <div class="card-body">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="latitude" class="form-label">Latitudine</label>
                            <input type="number" disabled class="form-control coordinate-input" id="latitude" name="latitude" 
                                   step="0.000001" min="-90" max="90"
                                   value="{{ channel.latitude if channel and channel.latitude else '' }}"
                                   onchange="updateMapFromCoords()">
                            <div class="form-text">Coordinata Y (WGS84)</div>
                        </div>
                        <div class="col-md-4">
                            <label for="longitude" class="form-label">Longitudine</label>
                            <input type="number" disabled class="form-control coordinate-input" id="longitude" name="longitude" 
                                   step="0.000001" min="-180" max="180"
                                   value="{{ channel.longitude if channel and channel.longitude else '' }}"
                                   onchange="updateMapFromCoords()">
                            <div class="form-text">Coordinata X (WGS84)</div>
                        </div>
                        <div class="col-md-4">
                            <label for="elevation_m" class="form-label">Elevazione</label>
                            <div class="input-group">
                                <input type="number" disabled name="elevation_m" id="elevation_m" class="form-control" 
                                       value="{{ channel.elevation_m if channel else '' }}" 
                                       step="0.01" 
                                       placeholder="324.95">
                                <span class="input-group-text">m s.l.m.</span>
                            </div>
                            <div class="form-text">Altitudine sul livello del mare</div>
                        </div>
                    </div>
						
                    <div id="channelMap"></div>


                </div>
            </div> <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tags"></i> Metadata Aggiuntivi</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <label for="metadata" class="form-label">
                                <i class="fas fa-code"></i> Metadata JSON
                            </label>
                            <textarea name="metadata" disabled id="metadata" class="form-control font-monospace" rows="4" 
                                      placeholder='{"sensor_type": "TDR", "depth_m": -0.40, "calibration": "mineral_soil"}'>{{ channel.metadata | tojson if channel and channel.metadata else '{}' }}</textarea>
                            
                        </div>
                    </div>
                </div>
            </div> <div class="card mb-4">
                
    </div>

</form>

<script>
document.getElementById('formFieldset').disabled = true;
// =============================================
// FUNZIONI AGGIORNATE PER channel_form.html
// =============================================





function inheritCoordinates() {
    const itemSelect = document.getElementById('item_id');
    const selectedOption = itemSelect.options[itemSelect.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const longitude = selectedOption.getAttribute('data-longitude');
        const latitude = selectedOption.getAttribute('data-latitude');
        
        if (longitude && longitude !== '') {
            document.getElementById('longitude').value = longitude;
        }
        if (latitude && latitude !== '') {
            document.getElementById('latitude').value = latitude;
        }
        
        // NUOVO: Aggiorna anche la mappa
        if (longitude && latitude && longitude !== '' && latitude !== '') {
            const lat = parseFloat(latitude);
            const lng = parseFloat(longitude);
            const latlng = L.latLng(lat, lng);
            
            channelMap.setView(latlng, 18);
            updateChannelMarkerPosition(latlng);
        }
        
        // Feedback visivo (resto del codice esistente)
    } else {
        alert('Seleziona prima un item');
    }
	updateChannelNumberPreview();
}

function inheritAcquisitionMode() {
    const itemSelect = document.getElementById('item_id');
    const selectedOption = itemSelect.options[itemSelect.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const acquisitionType = selectedOption.getAttribute('data-acquisition-type');
        const acquisitionDate = selectedOption.getAttribute('data-acquisition-date');
        
        document.getElementById('acquisition_type').value = acquisitionType || 'continuous';
        updateAcquisitionModeDisplay(acquisitionType || 'continuous');
        
        if (acquisitionType === 'discrete' && acquisitionDate && acquisitionDate !== '') {
            document.getElementById('acquisition_date').value = acquisitionDate;
        }
        
        toggleAcquisitionSections(acquisitionType || 'continuous');
    }
}

function updateAcquisitionModeDisplay(acquisitionType) {
    const displayField = document.getElementById('acquisition_type_display');
    const modeNames = {
        'continuous': 'ðŸ”„ Continua',
        'discrete': 'ðŸ“… Discreta', 
        'periodic': 'ðŸ›°ï¸ Periodica'
    };
    displayField.value = modeNames[acquisitionType] || acquisitionType;
}

function toggleAcquisitionSections(acquisitionType) {
    const frequencySection = document.getElementById('frequencySection');
    const dateSection = document.getElementById('dateSection');
    
    if (acquisitionType === 'discrete') {
        frequencySection.style.display = 'none';
        dateSection.style.display = 'block';
    } else {
        frequencySection.style.display = 'block';
        dateSection.style.display = 'none';
    }
}

function updateFrequencyValue() {
    const value = parseInt(document.getElementById('acq_frequency_value').value) || 0;
    const unit = parseInt(document.getElementById('acq_frequency_unit').value) || 1;
    document.getElementById('acq_frequency').value = value * unit;
}

// Inizializza modalitÃ  acquisizione in edit mode
function initializeEditMode() {
    {% if action == 'edit' and channel %}
    const acquisitionType = '{{ channel.acquisition_type }}';

    // Imposta il valore del campo hidden
    document.getElementById('acquisition_type').value = acquisitionType;

    // Aggiorna la visualizzazione del campo di testo in sola lettura
    updateAcquisitionModeDisplay(acquisitionType);

    // Mostra/nascondi le sezioni appropriate
    toggleAcquisitionSections(acquisitionType);

    // Se Ã¨ discreto e c'Ã¨ una data, impostala
    if (acquisitionType === 'discrete' && '{{ channel.acquisition_date }}') {
        document.getElementById('acquisition_date').value = '{{ channel.acquisition_date.strftime("%Y-%m-%d") if channel.acquisition_date else "" }}';
    }

    // Se Ã¨ continuo/periodico e c'Ã¨ una frequenza, impostala
    if ((acquisitionType === 'continuous' || acquisitionType === 'periodic') && '{{ channel.acq_frequency }}') {
        const acqFrequency = parseInt('{{ channel.acq_frequency }}');

        let value = acqFrequency;
        let unit = 1;

        if (acqFrequency >= 86400) { // giorni
            value = acqFrequency / 86400;
            unit = 86400;
        } else if (acqFrequency >= 3600) { // ore
            value = acqFrequency / 3600;
            unit = 3600;
        } else if (acqFrequency >= 60) { // minuti
            value = acqFrequency / 60;
            unit = 60;
        }

        document.getElementById('acq_frequency_value').value = value;
        document.getElementById('acq_frequency_unit').value = unit;
        updateFrequencyValue();
    }
    {% endif %}
}

// EVENT LISTENERS AGGIORNATI
document.addEventListener('DOMContentLoaded', function() {
    // 1. Inizializzazioni
    initChannelMap();
    
    // 2. Riferimenti agli elementi con controlli di sicurezza
    const itemSelect = document.getElementById('item_id');
    const nameField = document.getElementById('name');
    const suffixField = document.getElementById('channel_suffix');
    const metadataField = document.getElementById('metadata');
    const channelForm = document.getElementById('channelForm');
    const suffixAlphaField = document.getElementById('channel_suffix_alpha');
    const acqFreqValue = document.getElementById('acq_frequency_value');
    const acqFreqUnit = document.getElementById('acq_frequency_unit');
    
    // 3. Event listeners solo se gli elementi esistono
    if (suffixAlphaField) {
        suffixAlphaField.addEventListener('input', function() {
            this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '');
            updateChannelNumberPreview();
        });
    }
    
    if (itemSelect) {
        itemSelect.addEventListener('change', function() {
            updateItemPrefix();
            inheritCoordinates();
            inheritAcquisitionMode(); // Aggiunto per ereditare la modalitÃ  di acquisizione
        });
    }
    
    if (nameField) {
        nameField.addEventListener('input', function() {
            if (suffixAlphaField && !suffixAlphaField.value.trim()) {
                clearTimeout(window.autoSuggestTimeout);
                window.autoSuggestTimeout = setTimeout(() => {
                    const name = nameField.value.trim();
                    if (name.length >= 3) {
                        generateSmartChannelSuffix(name, null);
                    }
                }, 1500);
            }
        });
    }

    if (suffixField) {
        suffixField.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
            updateFullCode();
        });
    }

    if (metadataField) {
        metadataField.addEventListener('input', function() {
            const value = this.value.trim();
            if (value === '' || value === '{}') {
                this.classList.remove('is-invalid', 'is-valid');
                return;
            }
            try {
                JSON.parse(value);
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } catch (e) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    }
    
    if (channelForm) {
    channelForm.addEventListener('submit', function(e) {
        const metadata = metadataField ? metadataField.value.trim() : '';
        const isEditMode = '{{ action }}' === 'edit';
        
        // âœ… FIX: Validazione suffisso solo in new mode
        if (!isEditMode) {
            const suffix = suffixAlphaField ? suffixAlphaField.value.trim() : '';
            
            if (!suffix) {
                e.preventDefault();
                alert('Inserisci l\'abbreviazione del channel (es: TMP, HUM, VOL)');
                if (suffixAlphaField) suffixAlphaField.focus();
                return false;
            }
        }
        
        // Validazione item (sempre necessaria)
        if (!isEditMode && (!itemSelect || !itemSelect.value)) {
            e.preventDefault();
            alert('Seleziona un item per il channel');
            if (itemSelect) itemSelect.focus();
            return false;
        }
        
        // Aggiorna codice solo in new mode
        if (!isEditMode) {
            updateFullCode();
        }
        
        // Validazione metadata (sempre)
        if (metadata && metadata !== '{}') {
            try {
                JSON.parse(metadata);
            } catch (error) {
                e.preventDefault();
                alert('Errore nel formato JSON dei metadata. Correggi prima di salvare.');
                if (metadataField) metadataField.focus();
                return false;
            }
        }
        return true;
    });
}
    
    if (acqFreqValue) {
        acqFreqValue.addEventListener('input', updateFrequencyValue);
    }
    
    if (acqFreqUnit) {
        acqFreqUnit.addEventListener('change', updateFrequencyValue);
    }

    // 4. Inizializzazioni specifiche per edit mode
    {% if action == 'edit' %}
        initializeEditMode();
        
        // In edit mode, inizializza i campi se un item Ã¨ pre-selezionato
        if (itemSelect && itemSelect.value) {
            updateItemPrefix();
            updateFullCode();
        }
    {% endif %}
});

// =============================================
// FUNZIONI MAPPA (RIMANGONO INVARIATE)
// =============================================

// Variabili mappa
let channelMap;
let channelMarker;



function initChannelMap() {
    const defaultLat = {{ channel.latitude if channel and channel.latitude else 40.8518 }};
    const defaultLng = {{ channel.longitude if channel and channel.longitude else 14.2681 }};
    
    channelMap = L.map('channelMap').setView([defaultLat, defaultLng], 20);
    
    // Layer mappa (copia da item_form.html)
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    });
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles Â© Esri'
    });
    satellite.addTo(channelMap);
    
    L.control.layers({
        "OpenStreetMap": osm,
        "Satellite": satellite
    }).addTo(channelMap);
    
    // Marker esistente se in edit mode
    {% if action == 'edit' and channel and channel.latitude and channel.longitude %}
    channelMarker = L.marker([{{ channel.latitude }}, {{ channel.longitude }}], {
        draggable: true
    }).addTo(channelMap);
    channelMarker.on('dragend', function(e) {
        updateCoordsFromMap(e.target.getLatLng());
    });
    {% endif %}
    
    // Click sulla mappa
    channelMap.on('click', function(e) {
        updateChannelMarkerPosition(e.latlng);
        updateCoordsFromMap(e.latlng);
    });
}



</script>
{% endblock %}