{% extends "base.html" %}

{% block title %}Items - Mercurio{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-microchip"></i> Items</h1>
        <p class="text-muted">Gestione dispositivi fisici, sensori e strumenti di monitoraggio</p>
    </div>
    <div class="col-auto">
        <div class="btn-group" role="group">
		 	<button class="btn btn-outline-secondary" onclick="toggleMapView()">
				<i class="fas fa-globe"></i> Vista Mappa
			</button>
        </div>
    </div>
</div>

<!-- Statistiche rapide  -->
<div class="stats-row mb-4">

    <div class="stats-item-7x">
        <div class="card stats-card">
            <div class="card-body text-center text-white">
                <i class="fas fa-microchip fa-2x mb-2"></i>
                <h3 class="mb-0">{{ items|length }}</h3>
                <small>Items collegati</small>
            </div>
        </div>
    </div>

    <div class="stats-item-7x">
        <div class="card stats-card">
            <div class="card-body text-center text-white">
                <i class="fas fa-satellite-dish fa-2x mb-2"></i>
                <h3 class="mb-0">{{ items|map(attribute='total_channels')|sum }}</h3>
                <small>Canali collegati</small>
            </div>
        </div>
    </div>

    <div class="stats-item-7x">
        <div class="card stats-card">
            <div class="card-body text-center text-white">
                <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                <h3 class="mb-0">
                    {{ items|map(attribute='area_name')|reject('none')|unique|list|length }}
                </h3>
                <small>Aree</small>
            </div>
        </div>
    </div>

    <div class="stats-item-7x">
        <div class="card stats-card">
            <div class="card-body text-center text-white">
                <i class="fas fa-globe-americas fa-2x mb-2"></i>
                <h3 class="mb-0">
                    {{ items|map(attribute='scenario_name')|reject('none')|unique|list|length }}
                </h3>
                <small>Scenari Attivi</small>
            </div>
        </div>
    </div>

</div>


<!-- Filtri e Ricerca -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Ricerca</label>
                        <input type="text" id="searchItems" class="form-control" 
                               placeholder="Nome, codice...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Scenari</label>
                        <select id="filterScenario" class="form-select">
                            <option value="">Tutti</option>
                            {% set scenarios = items|map(attribute='scenario_name')|reject('none')|unique|sort %}
                            {% for scenario in scenarios %}
                            <option value="{{ scenario }}">{{ scenario }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Aree</label>
                        <select id="filterArea" class="form-select">
                            <option value="">Tutte</option>
                            <!-- Popolate dinamicamente -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Sistemi</label>
                        <select id="filterSystem" class="form-select">
                            <option value="">Tutti</option>
                            <!-- Popolate dinamicamente -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Misure</label>
                        <select id="filterMeasurement" class="form-select">
                            <option value="">Tutti</option>
                            <!-- Popolate dinamicamente -->
                        </select>
                    </div>
					
						<button id="resetFiltersBtn" class="btn btn-outline-secondary">
							<i class="fas fa-undo"></i> Reset Filtri
						</button>
						
						
				

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vista Mappa (nascosta inizialmente) -->
<div id="mapView" class="card mb-4" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-map"></i> Mappa Items 
            <span class="badge bg-primary" id="mapItemsCount">{{ items|length }}</span>
        </h5>
        <div>
            <div class="btn-group btn-group-sm me-2" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="fitAllItems()">
                    <i class="fas fa-expand-arrows-alt"></i> Mostra Tutti
                </button>
                <button type="button" class="btn btn-outline-info" onclick="centerOnItaly()">
                    <i class="fas fa-home"></i> Italia
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="toggleMapStyle()">
                    <i class="fas fa-layer-group"></i> Stile
                </button>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="toggleMapView()">
                <i class="fas fa-times"></i> Chiudi
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="itemsMap" style="height: 500px; position: relative;">
            <div id="mapLoadingOverlay" class="d-flex align-items-center justify-content-center h-100 bg-light">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary mb-2"></i>
                    <p class="text-muted">Caricamento mappa...</p>
                </div>
            </div>
        </div>
    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col-md-8">
                <div class="d-flex flex-wrap gap-2">
                    <small class="badge bg-success"><i class="fas fa-circle"></i> Continui</small>
                    <small class="badge bg-warning"><i class="fas fa-circle"></i> Discreti</small>
                    <small class="badge bg-info"><i class="fas fa-circle"></i> Periodici</small>
                    <small class="badge bg-secondary"><i class="fas fa-circle"></i> Non definiti</small>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <small class="text-muted">
                    Clicca sui marker per vedere i dettagli
                </small>
            </div>
        </div>
    </div>
</div>



{% if items %}
<!-- Lista Items -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list"></i> Lista Items
            <span class="badge bg-secondary ms-2" id="itemsCount">{{ items|length }}</span>
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Codice</th>
                        <th>Nome</th>
                        <th>Gerarchia</th>
                        <th>Coordinate</th>
						<th>Tipo/Data</th>
                        <th>Canali</th>
                        <th>Metadata</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    {% for item in items %}
                    <tr data-scenario="{{ item.scenario_name or '' }}" 
                        data-area="{{ item.area_name or '' }}"
                        data-system="{{ item.system_name or '' }}"
                        data-measurement="{{ item.measurement_name or '' }}"
						data-acquisition="{{ item.acquisition_type or '' }}" 
                        data-search="{{ (item.name|lower) + ' ' + (item.code|lower if item.code else '') }}">
                        <td>
                            <strong class="text-primary font-monospace">{{ item.code or item.item_id }}</strong>
                        </td>
                        <td>
                            <div>
                                <strong>{{ item.name }}</strong>
                                {% if item.description %}
                                <br><small class="text-muted">{{ item.description[:60] }}{% if item.description|length > 60 %}...{% endif %}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                <!-- Scenario -->
                                <div class="mb-1">
                                    <span class="badge bg-primary">{{ item.scenario_code or 'N/A' }}</span>
                                    <small>{{ item.scenario_name or 'N/A' }}</small>
                                </div>
                                <!-- Area -->
                                <div class="mb-1">
                                    <span class="badge bg-info">{{ item.area_code or 'N/A' }}</span>
                                    <small>{{ item.area_name or 'N/A' }}</small>
                                </div>
                                <!-- System ‚Üí Measurement -->
                                <div>
                                    <span class="badge bg-secondary">{{ item.system_name or 'N/A' }}</span>
                                    <small>‚Üí {{ item.measurement_name or 'N/A' }}</small>
                                    {% if item.measurement_code %}
                                    <small class="text-muted">({{ item.measurement_code }})</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if item.latitude and item.longitude %}
                            <small class="text-muted font-monospace">
                                <i class="fas fa-map-marker-alt text-danger"></i><br>
                                {{ "%.5f"|format(item.latitude) }}<br>
                                {{ "%.5f"|format(item.longitude) }}
                                {% if item.elevation_m %}
                                <br><small class="text-info">{{ item.elevation_m }}m</small>
                                {% endif %}
                            </small>
                            {% else %}
                            <small class="text-muted">Non definite</small>
                            {% endif %}
                        </td>
						
						<td>
							<div class="small">
								{% if item.acquisition_type == 'continuous' %}
								<span class="badge bg-success">üîÑ Continua</span>
								{% elif item.acquisition_type == 'discrete' %}
								<span class="badge bg-warning">üìÖ Discreta</span>
								{% elif item.acquisition_type == 'periodic' %}
								<span class="badge bg-info">üõ∞Ô∏è Periodica</span>
								{% else %}
								<span class="badge bg-secondary">{{ item.acquisition_type or 'N/A' }}</span>
								{% endif %}
								
								{% if item.acquisition_date %}
								<br><small class="text-muted">
									<i class="fas fa-calendar"></i> {{ item.acquisition_date.strftime('%d/%m/%Y') }}
								</small>
								{% endif %}
							</div>
						</td>
						
						<td class="text-center">
							<h6 class="text-primary fw-bold mb-0">{{ item.total_channels or 0 }}</h6>

							
						</td>
                        <td>
                            {% if item.metadata and item.metadata != '{}' %}
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="showMetadata('{{ item.item_id }}', '{{ item.name }}')" 
                                    title="Visualizza metadata">
                                <i class="fas fa-tags"></i>
                            </button>
                            {% else %}
                            <small class="text-muted">Nessun metadata</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('items.edit_item', item_id=item.item_id) }}" 
                                   class="btn btn-outline-primary btn-sm" title="Dettagli">
                                    <i class="fas fa-edit"></i>
                                </a>
                                
                                <button class="btn btn-outline-info btn-sm" 
                                        onclick="manageChannels('{{ item.item_id }}', '{{ item.name }}')" 
                                        title="Gestisci Canali">
                                    <i class="fas fa-stream"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<div class="text-center py-5">
    <div class="card">
        <div class="card-body">
            <i class="fas fa-microchip fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">Nessun Item Configurato</h4>
            <p class="text-muted">Inizia creando il primo item di monitoraggio</p>
            <div class="mt-3">
                <a href="{{ url_for('items.new_item') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Crea Primo Item
                </a>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <strong>Prerequisiti:</strong> Assicurati di aver creato almeno uno Scenario, un'Area, 
                    un System e un Measurement prima di creare items.
                </small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Metadata -->
<div class="modal fade" id="metadataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tags"></i> 
                    Metadata Item: <span id="modalItemName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="modalMetadataContent" class="bg-light p-3 rounded" style="font-size: 0.9em;"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Modal Conferma Eliminazione -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conferma Eliminazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare l'item <strong id="deleteItemName"></strong>?</p>
                <p class="text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Questa azione √® irreversibile.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Elimina
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Mostra metadata
function showMetadata(itemId, itemName) {
    console.log('=== DEBUG ITEMS METADATA ===');
    console.log('Item ID ricevuto:', itemId, typeof itemId);
    
    document.getElementById('modalItemName').textContent = itemName;
    
    const items = {{ items | tojson }};
    console.log('Array items:', items);
    
    const itmId = parseInt(itemId);
    console.log('Item ID convertito:', itmId);
    
    const item = items.find(i => {
        console.log('Confronto:', i.item_id, 'con', itmId, 'uguali?', i.item_id === itmId);
        return i.item_id === itmId;
    });
    
    console.log('Item trovato:', item);
    
    const modal = new bootstrap.Modal(document.getElementById('metadataModal'));
    modal.show();
    
    if (item) {
        console.log('Metadata dell\'item:', item.metadata);
        console.log('Tipo metadata:', typeof item.metadata);
        
        if (item.metadata && Object.keys(item.metadata).length > 0) {
            let metadata = item.metadata;
            if (typeof metadata === 'string') {
                try {
                    metadata = JSON.parse(metadata);
                } catch (e) {
                    console.log('Errore parse JSON:', e);
                }
            }
            
            document.getElementById('modalMetadataContent').textContent = 
                JSON.stringify(metadata, null, 2);
        } else {
            console.log('Metadata vuoti o non presenti');
            document.getElementById('modalMetadataContent').textContent = 'Nessun metadata disponibile';
        }
    } else {
        console.log('Item non trovato nell\'array');
        document.getElementById('modalMetadataContent').textContent = 'Item non trovato';
    }
}

// Conferma eliminazione
function confirmDelete(itemId, itemName) {
    document.getElementById('deleteItemName').textContent = itemName;
    document.getElementById('deleteForm').action = '/items/delete/' + encodeURIComponent(itemId);
    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
}

// Gestisci channels
function manageChannels(itemId, itemName) {
    window.location.href = `/channels?item=${itemId}`;
}

// Gestione Channels da popup
function showItemChannels(itemId, itemName) {
    if (itemsMap) {
        itemsMap.closePopup();
    }
    window.location.href = `/channels?item=${itemId}`;
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== DATI =====
    const itemsData = {{ items|tojson|safe }};
    let currentFilteredItems = itemsData; 
    
    // ===== ELEMENTI DOM =====
    const scenarioSelect = document.getElementById('filterScenario');
    const areaSelect = document.getElementById('filterArea');
    const systemSelect = document.getElementById('filterSystem');
    const measurementSelect = document.getElementById('filterMeasurement');
    const searchField = document.getElementById('searchItems');
    const resetBtn = document.getElementById('resetFiltersBtn');
    const itemsCountEl = document.getElementById('itemsCount');
    
    // ===== FUNZIONI UTILI =====
    function updateSelectOptions(selectElement, options, keepCurrent = false) {
        const currentValue = keepCurrent ? selectElement.value : '';
        const firstOption = selectElement.options[0];

        selectElement.innerHTML = '';
        selectElement.appendChild(firstOption);

        const uniqueOptions = [...new Set(options)].filter(opt => opt).sort();
        uniqueOptions.forEach(option => {
            const optionEl = document.createElement('option');
            optionEl.value = option;
            optionEl.textContent = option;
            selectElement.appendChild(optionEl);
        });

        if (keepCurrent && currentValue && Array.from(selectElement.options).some(opt => opt.value === currentValue)) {
            selectElement.value = currentValue;
        } else {
            selectElement.value = '';
        }
    }

    function updateAllFilters(isReset = false) {
		const selectedScenario = scenarioSelect.value.trim().toLowerCase();
		const selectedArea = areaSelect.value.trim().toLowerCase();
		const selectedSystem = systemSelect.value.trim().toLowerCase();

		let filteredItems = itemsData;

		if (selectedScenario) {
			filteredItems = filteredItems.filter(item => (item.scenario_name || '').trim().toLowerCase() === selectedScenario);
		}
		if (selectedArea) {
			filteredItems = filteredItems.filter(item => (item.area_name || '').trim().toLowerCase() === selectedArea);
		}
		if (selectedSystem) {
			filteredItems = filteredItems.filter(item => (item.system_name || '').trim().toLowerCase() === selectedSystem);
		}

		// Popola le select dinamicamente con valori unici, trim e sort
		const availableAreas = filteredItems.map(item => (item.area_name || '').trim()).filter(a => a);
		const availableSystems = filteredItems.map(item => (item.system_name || '').trim()).filter(s => s);
		const availableMeasurements = filteredItems.map(item => (item.measurement_name || '').trim()).filter(m => m);

		updateSelectOptions(areaSelect, availableAreas, !isReset);
		updateSelectOptions(systemSelect, availableSystems, !isReset);
		updateSelectOptions(measurementSelect, availableMeasurements, !isReset);

		applyFilters();
	}

    // ===== APPLICA FILTRI E RICERCA =====
    function applyFilters() {
		const searchTerm = searchField.value.toLowerCase().trim();
		const scenarioFilter = scenarioSelect.value.toLowerCase().trim();
		const areaFilter = areaSelect.value.toLowerCase().trim();
		const systemFilter = systemSelect.value.toLowerCase().trim();
		const measurementFilter = measurementSelect.value.toLowerCase().trim();

		const rows = document.querySelectorAll('#itemsTableBody tr');
		let visibleCount = 0;

		rows.forEach(row => {
			const searchContent = (row.dataset.search || '').toLowerCase().trim();
			const scenario = (row.dataset.scenario || '').toLowerCase().trim();
			const area = (row.dataset.area || '').toLowerCase().trim();
			const system = (row.dataset.system || '').toLowerCase().trim();
			const measurement = (row.dataset.measurement || '').toLowerCase().trim();

			const matchesSearch = searchContent.includes(searchTerm);
			const matchesScenario = !scenarioFilter || scenario === scenarioFilter;
			const matchesArea = !areaFilter || area === areaFilter;
			const matchesSystem = !systemFilter || system === systemFilter;
			const matchesMeasurement = !measurementFilter || measurement === measurementFilter;

			if (matchesSearch && matchesScenario && matchesArea && matchesSystem && matchesMeasurement) {
				row.style.display = '';
				visibleCount++;
			} else {
				row.style.display = 'none';
			}
		});

		itemsCountEl.textContent = visibleCount;

		// Aggiorna currentFilteredItems
		currentFilteredItems = itemsData.filter(item => {
			const searchContent = `${item.name} ${item.code || ''}`.toLowerCase().trim();
			const scenario = (item.scenario_name || '').toLowerCase().trim();
			const area = (item.area_name || '').toLowerCase().trim();
			const system = (item.system_name || '').toLowerCase().trim();
			const measurement = (item.measurement_name || '').toLowerCase().trim();

			const matchesSearch = !searchTerm || searchContent.includes(searchTerm);
			const matchesScenario = !scenarioFilter || scenario === scenarioFilter;
			const matchesArea = !areaFilter || area === areaFilter;
			const matchesSystem = !systemFilter || system === systemFilter;
			const matchesMeasurement = !measurementFilter || measurement === measurementFilter;

			return matchesSearch && matchesScenario && matchesArea && matchesSystem && matchesMeasurement;
		});

		// Aggiorna mappa se attiva
		if (itemsMap && markersCluster) {
			window.MapCommon.loadEntitiesOnMap(currentFilteredItems, itemsConfig, markersCluster, itemMarkers);
		}
	}



    // ===== RESET FILTRI =====
    function resetAllFilters() {
        searchField.value = '';
        scenarioSelect.value = '';
        areaSelect.value = '';
        systemSelect.value = '';
        measurementSelect.value = '';

        updateAllFilters(true);

        if (itemsMap && markersCluster) {
            window.updateItemsMapView();
        }
    }

    // ===== LISTENERS =====
    scenarioSelect.addEventListener('change', function() {
        areaSelect.value = '';
        systemSelect.value = '';
        measurementSelect.value = '';
        updateAllFilters();
    });

    areaSelect.addEventListener('change', function() {
        systemSelect.value = '';
        measurementSelect.value = '';
        updateAllFilters();
    });

    systemSelect.addEventListener('change', applyFilters);
    measurementSelect.addEventListener('change', applyFilters);

    let searchTimeout;
    searchField.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
    });

    if (resetBtn) resetBtn.addEventListener('click', resetAllFilters);

    // ===== INIZIALIZZAZIONE =====
    updateAllFilters();

    // ===== ESPONI FUNZIONI GLOBALI =====
    window.applyFilters = applyFilters;
    window.updateAllFilters = updateAllFilters;
    window.currentFilteredItems = currentFilteredItems;
});
</script>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    .item-marker-continuous { background-color: #198754; }
    .item-marker-discrete { background-color: #ffc107; }
    .item-marker-periodic { background-color: #0dcaf0; }
    .item-marker-undefined { background-color: #6c757d; }
    
    .leaflet-popup .popup-header {
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 5px;
    }
    
    .leaflet-popup .popup-badges {
        margin: 5px 0;
    }
    
    .leaflet-popup .popup-actions {
        margin-top: 10px;
        text-align: center;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- ‚úÖ SOLO MAP-COMMON.JS - RIMOSSO MAP-MANAGER.JS -->
<script src="{{ url_for('static', filename='js/map-common.js') }}"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
// === CONFIGURAZIONE ITEMS ===
const itemsConfig = {
    entityType: 'item',
    entitiesProperty: 'items',
    markerPrefix: 'item-marker',
    mapContainerId: 'itemsMap',
    loadingOverlayId: 'mapLoadingOverlay',
    counterElementId: 'mapItemsCount',
    listCounterElementId: 'itemsCount',
    defaultColor: '#6c757d',
    
    popupBuilder: {
        single: function(item) {
            let acquisitionIcon = 'fas fa-question';
            let acquisitionText = 'Non definito';
            
            switch(item.acquisition_type) {
                case 'continuous':
                    acquisitionIcon = 'fas fa-sync-alt';
                    acquisitionText = 'Continua';
                    break;
                case 'discrete':
                    acquisitionIcon = 'fas fa-calendar-day';
                    acquisitionText = 'Discreta';
                    break;
                case 'periodic':
                    acquisitionIcon = 'fas fa-clock';
                    acquisitionText = 'Periodica';
                    break;
            }
            
            return `
                <div class="popup-content">
                    <div class="popup-header">
                        <i class="fas fa-microchip"></i> ${item.name}
                    </div>
                    
                    <div class="popup-badges">
                        <span class="badge bg-primary">${item.code || item.item_id}</span>
                        <span class="badge bg-secondary">
                            <i class="${acquisitionIcon}"></i> ${acquisitionText}
                        </span>
                    </div>
                    
                    <div class="small mb-2">
                        <div><strong>Scenario:</strong> ${item.scenario_name || 'N/A'}</div>
                        <div><strong>Area:</strong> ${item.area_name || 'N/A'}</div>
                        <div><strong>Sistema:</strong> ${item.system_name || 'N/A'}</div>
                        <div><strong>Misura:</strong> ${item.measurement_name || 'N/A'}</div>
                    </div>
                    
                    <div class="small mb-2">
                        <div><strong>Coordinate:</strong> ${item.latitude.toFixed(6)}, ${item.longitude.toFixed(6)}</div>
                        ${item.elevation_m ? `<div><strong>Elevazione:</strong> ${item.elevation_m}m</div>` : ''}
                        ${item.total_channels ? `<div><strong>Canali:</strong> ${item.total_channels}</div>` : ''}
                    </div>
                    
                    ${item.description ? `<div class="small text-muted mb-2">${item.description}</div>` : ''}
                    
                    <div class="popup-actions">
                        <a href="/items/edit/${item.item_id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i> Dettagli
                        </a>
                        <button class="btn btn-sm btn-outline-info" onclick="showItemChannels(${item.item_id}, '${item.name}')">
                            <i class="fas fa-stream"></i> Canali
                        </button>
                    </div>
                </div>
            `;
        },
        
        multi: function(items) {
            const lat = items[0].latitude.toFixed(6);
            const lng = items[0].longitude.toFixed(6);
            
            const itemsList = items.map(item => `
                <div class="border-bottom py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${item.name}</strong>
                            <br><span class="badge bg-primary">${item.code || item.item_id}</span>
                            <br><small class="text-muted">${item.area_name || 'N/A'} ‚Ä¢ ${item.measurement_name || 'N/A'}</small>
                        </div>
                        <div class="text-end">
                            <a href="/items/edit/${item.item_id}" class="btn btn-xs btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="popup-content">
                    <div class="popup-header text-center">
                        <i class="fas fa-layer-group"></i> ${items.length} items in questa posizione
                    </div>
                    
                    <div class="small mb-2 text-center">
                        <strong>Coordinate:</strong> ${lat}, ${lng}
                    </div>
                    
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${itemsList}
                    </div>
                    
                    <div class="popup-actions mt-2">
                        <small class="text-muted">Items con coordinate identiche o molto vicine</small>
                    </div>
                </div>
            `;
        }
    },
    
    getSearchTerm: function() {
        const element = document.getElementById('searchItems');
        return element ? element.value.toLowerCase() : '';
    },
    
    getFilters: function() {
        return {
            scenario: document.getElementById('filterScenario')?.value || '',
            area: document.getElementById('filterArea')?.value || '',
            system: document.getElementById('filterSystem')?.value || '',
            measurement: document.getElementById('filterMeasurement')?.value || ''
        };
    },
    
    filterFunction: function(item, searchTerm, filters) {
        const searchContent = `${item.name} ${item.code || ''}`.toLowerCase();
        const scenario = item.scenario_name || '';
        const area = item.area_name || '';
        const system = item.system_name || '';
        const measurement = item.measurement_name || '';
        
        const matchesSearch = !searchTerm || searchContent.includes(searchTerm);
        const matchesScenario = !filters.scenario || scenario === filters.scenario;
        const matchesArea = !filters.area || area === filters.area;
        const matchesSystem = !filters.system || system === filters.system;
        const matchesMeasurement = !filters.measurement || measurement === filters.measurement;
        
        return matchesSearch && matchesScenario && matchesArea && matchesSystem && matchesMeasurement;
    }
};

// === VARIABILI MAPPA ===
let itemsMap = null;
let itemMarkers = [];
let markersCluster = null;
const items = {{ items|tojson|safe }};

// === FUNZIONI PRINCIPALI ===
function toggleMapView() {
    const mapView = document.getElementById('mapView');
    
    if (mapView.style.display === 'none') {
        // üëâ Assicura che currentFilteredItems sia aggiornato
        if (typeof window.applyFilters === 'function') window.applyFilters();

        mapView.style.display = 'block';
        mapView.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        if (!itemsMap) {
            setTimeout(async () => {
                await initializeItemsMap();
                if (typeof window.updateItemsMapView === 'function') {
                    window.updateItemsMapView();
                }
            }, 0);
        } else {
            setTimeout(() => {
                itemsMap.invalidateSize();

                // üëâ Forza ridisegno coi filtrati
                if (typeof window.updateItemsMapView === 'function') {
                    window.updateItemsMapView();
                }

                if (markersCluster && markersCluster.getLayers().length > 0) {
                    itemsMap.fitBounds(markersCluster.getBounds(), { padding: [20, 20] });
                }
            }, 100);
        }
    } else {
        mapView.style.display = 'none';
    }
}


async function initializeItemsMap() {
    try {
        const result = await window.MapCommon.initializeEntityMap(itemsConfig);
        itemsMap = result.map;
        markersCluster = result.markersCluster;
        itemsConfig.mapInstance = itemsMap;
        
        // ‚úÖ CAMBIARE: usa currentFilteredItems invece di items
        await window.MapCommon.loadEntitiesOnMap(currentFilteredItems, itemsConfig, markersCluster, itemMarkers);
        
        if (itemMarkers.length > 0) {
            fitAllItems();
        }
        
    } catch (error) {
        console.error('Errore inizializzazione mappa items:', error);
    }
}

function fitAllItems() {
    window.MapCommon.fitAllEntities(itemsMap, markersCluster);
}

function centerOnItaly() {
    window.MapCommon.centerOnItaly(itemsMap);
}

function toggleMapStyle() {
    window.MapCommon.toggleMapStyle(itemsMap);
}

function updateItemsMapView() {
    window.MapCommon.updateEntityMapView(itemsConfig, itemMarkers, markersCluster);
}

// === ESPORTA FUNZIONI GLOBALI ===
window.toggleMapView = toggleMapView;
window.fitAllItems = fitAllItems;
window.centerOnItaly = centerOnItaly;
window.updateItemsMapView = updateItemsMapView;
window.toggleMapStyle = toggleMapStyle;
</script>
{% endblock %}