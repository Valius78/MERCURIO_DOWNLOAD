{% extends "base.html" %}

{% block title %}
    {% if action == 'edit' %}Modifica Area{% else %}Nuova Area{% endif %} - Mercurio
{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
		/* Stili per controlli mappa esterni */
		.btn-toolbar .btn-group {
			margin-right: 0.5rem;
		}
		
		.btn-toolbar .btn {
			white-space: nowrap;
		}
		
		/* Alert personalizzato */
		.alert-sm {
			padding: 0.5rem;
			font-size: 0.875rem;
		}
		
		/* Mappa */
		#map {
			width: 100%;
			height: 400px;
			border: 1px solid #ddd;
			border-radius: 8px;
		}
		
		/* Stato geometria */
		.card-body.bg-light {
			background-color: #f8f9fa !important;
			border-radius: 4px;
		}
		
		/* Cursore durante il disegno */
		.leaflet-container.crosshair {
			cursor: crosshair !important;
		}
		
		/* Tooltip personalizzato per i punti */
		.drawing-point {
			animation: pulse 1s infinite;
		}
		
		@keyframes pulse {
			0% { transform: scale(1); }
			50% { transform: scale(1.1); }
			100% { transform: scale(1); }
		}
		
		/* Responsive */
		@media (max-width: 768px) {
			.btn-toolbar {
				flex-direction: column;
			}
			
			.btn-group {
				width: 100%;
				margin-bottom: 0.5rem;
			}
			
			#map {
				height: 300px;
			}
		}
		
		/* Container pulsanti fisso */
		.map-controls {
			min-height: 60px; /* Spazio fisso riservato */
			padding: 0.75rem;
			background: #f8f9fa;
			border: 1px solid #dee2e6;
			border-radius: 8px 8px 0 0;
			border-bottom: none;
		}

		.map-controls .btn-toolbar {
			justify-content: space-between;
			align-items: center;
			flex-wrap: nowrap; /* Impedisce wrapping */
		}

		.map-controls .btn-group {
			flex-shrink: 0; /* Non si riduce */
		}

		/* Pulsanti mappa pi√π compatti */
		.map-controls .btn {
			font-size: 0.875rem;
			padding: 0.5rem 0.75rem;
			white-space: nowrap;
		}

		/* Alert flottanti per non spostare layout */
		.map-alert {
			position: absolute;
			top: 10px;
			left: 50%;
			transform: translateX(-50%);
			z-index: 1000;
			min-width: 300px;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
		}

		/* Stili per i punti di disegno */
		.drawing-point-first {
			animation: pulse-red 1.5s infinite;
		}

		.drawing-point-other {
			animation: pulse-blue 1s infinite;
		}

		@keyframes pulse-red {
			0% { transform: scale(1); opacity: 1; }
			50% { transform: scale(1.3); opacity: 0.7; }
			100% { transform: scale(1); opacity: 1; }
		}

		@keyframes pulse-blue {
			0% { transform: scale(1); opacity: 1; }
			50% { transform: scale(1.1); opacity: 0.8; }
			100% { transform: scale(1); opacity: 1; }
		}

		/* Responsive migliorato */
		@media (max-width: 768px) {
			.map-controls .btn-toolbar {
				flex-direction: column;
				gap: 0.5rem;
			}
			
			.map-controls {
				min-height: 120px; /* Pi√π spazio su mobile */
			}
			
			.map-controls .btn-group {
				width: 100%;
			}
			
			.map-controls .btn {
				flex: 1;
				font-size: 0.8rem;
				padding: 0.4rem 0.5rem;
			}
		}
	</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>
            <i class="fas fa-{{ 'edit' if action == 'edit' else 'plus' }}"></i>
            Area
        </h1>
        <p class="text-muted">
			Informazioni e geometria dell'area esistente
        </p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('areas.areas') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Torna alla Lista
        </a>
    </div>
</div>

<form method="POST" action="{{ url_for('areas.save_area') }}" id="areaForm">
    {% if area %}
        <input type="hidden" name="area_id" value="{{ area.area_id }}">
    {% endif %}
    
    <input type="hidden" id="center_latitude" name="center_latitude" value="{{ area.latitude if area else '' }}">
    <input type="hidden" id="center_longitude" name="center_longitude" value="{{ area.longitude if area else '' }}">
    <input type="hidden" id="area_geometry" name="area_geometry" value="{{ area.area_geometry if area else '' }}">
    
    <div class="row">
        <div class="col-md-4">
			 <fieldset id="formFieldset">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Informazioni Base</h5>
                </div>
                <div class="card-body">
                    
					<div class="mb-3">
                        <label for="scenario_id" class="form-label">Scenario</label>
                        <select class="form-select" id="scenario_id" name="scenario_id" required>
                            <option value="">Seleziona scenario...</option>
                            {% for scenario in scenarios %}
                            <option value="{{ scenario.scenario_id }}"
                                    {% if area and area.scenario_id == scenario.scenario_id %}selected{% endif %}>
                                {{ scenario.name }}
                                {% if scenario.description %} - {{ scenario.description[:50] }}...{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        
                    </div>
					
					
					
					
					<div class="mb-3">
                        <label for="name" class="form-label">Nome Area</label>
                        <input type="text" class="form-control" id="name" name="name"
                               value="{{ area.name if area else '' }}"
                               placeholder="es. Area Frana, Galleria Nord, Ponte Est..." required>
                        
                    </div>
					
					<div class="mb-3">
						<label for="area_code" class="form-label">Codice Area</label>
						<input type="text" class="form-control" id="area_code" name="area_code" 
							   value="{{ area.code if area else '' }}" 
							   readonly style="background-color: #f8f9fa; font-family: monospace; font-weight: bold;">
						
					</div>
					
					<div class="mb-3">
						<label for="description" class="form-label">Descrizione</label>
						<textarea class="form-control" id="description" name="description" 
								  rows="3" placeholder="Descrizione dettagliata dell'area di monitoraggio..."
								  maxlength="500">{{ area.description if area else '' }}</textarea>
						
					</div>
                    
                    
                    
                    
					<div class="mb-3">
						<label for="area_type" class="form-label">Tipo Area</label>
						<select class="form-select" id="area_type_select" name="area_type_select" required>
							<option value="">Seleziona tipo...</option>
							{% for area_type in area_types %}
							<option value="{{ area_type }}" 
									{% if area and area.area_type == area_type %}selected{% endif %}>
								{{ area_type }}
							</option>
							{% endfor %}
							<option value="_custom">‚ûï Nuovo tipo personalizzato</option>
						</select>
						
						
						<!-- Campo input per nuovo tipo (nascosto di default) -->
						<div id="custom_type_container" class="mt-2" style="display: none;">
							<input type="text" class="form-control" id="custom_area_type" name="custom_area_type"
								   placeholder="Inserisci nuovo tipo di area..."
								   maxlength="100">
							<div class="form-text">Nome del nuovo tipo di area (es: "Monitoraggio Diga", "Controllo Versante")</div>
						</div>
						
						<!-- Campo hidden che conterr√† il valore finale -->
						<input type="hidden" id="final_area_type" name="area_type" value="{{ area.area_type if area else '' }}">
					</div>                    
                    
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-tags"></i> Metadata Aggiuntivi</h5>
                </div>
                <div class="card-body">
                    {% if area and area.metadata %}
                        {% set meta = area.metadata %}
                    {% else %}
                        {% set meta = {} %}
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="reference_doc" class="form-label">Documento di Riferimento</label>
                        <input type="text" class="form-control" id="reference_doc" name="reference_doc"
                               value="{{ meta.reference_doc if meta.reference_doc is defined else '' }}">
                    </div>
                </div>
            </div>
            
           
			</fieldset>
        </div>

 		<div class="col-md-8">
			<div class="card">
				<div class="card-header">
					<h5><i class="fas fa-map"></i> Geometria Area</h5>
				</div>
				
				<!-- CONTROLLI FISSI -->
				
				
				<div class="card-body p-0">
					<!-- MAPPA SENZA BORDO SUPERIORE -->
					<div id="map" style="height: 400px; position: relative;"></div>
					
					<!-- CONTAINER PER ALERT FLOTTANTI -->
					<div id="mapAlertContainer" style="position: relative;"></div>
					
					<!-- STATO E ISTRUZIONI SOTTO LA MAPPA -->
					<div class="p-3 border-top bg-light">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<span id="statusText"></span>
							</div>
							<div id="coordsDisplay" style="display: none;">
								<span class="text-muted small me-2">Centro Area:</span>
								<span class="badge bg-white text-dark border">
									<i class="fas fa-crosshairs text-primary me-1"></i>
									Lat: <strong id="displayLat">-</strong>
								</span>
								<span class="badge bg-white text-dark border ms-1">
									Lon: <strong id="displayLng">-</strong>
								</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
    </div>
</form>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
	<script>
		let map;
		let drawnItems;
		let currentPolygon = null;
		let isDrawing = false;
		let drawingPoints = [];
		document.getElementById('formFieldset').disabled = true;
		
		document.addEventListener('DOMContentLoaded', function() {
			initMap();
			updateGeometryStatus();
		});

		// Inizializzazione mappa semplificata
		function initMap() {
			let defaultLat = {{ area.latitude if area else 40.8518 }};
			let defaultLng = {{ area.longitude if area else 14.2681 }};

			// Inizializza mappa
			map = L.map('map', {
				center: [defaultLat, defaultLng],
				zoom: 8,
				maxZoom: 18
			});
			
			// Layer mappa
			const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; OpenStreetMap contributors'
			});
			
			const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
				attribution: 'Tiles &copy; Esri'
			});

			osm.addTo(map);
			
			// Controllo layer
			L.control.layers({
				"OpenStreetMap": osm,
				"Satellite": satellite
			}).addTo(map);

			


			// Layer per elementi disegnati
			drawnItems = new L.FeatureGroup();
			map.addLayer(drawnItems);
			
			// Event handler per il click sulla mappa durante il disegno
			map.on('click', onMapClick);
			
			// Carica geometria esistente se presente
			loadExistingGeometry();
		}



		// Gestisce i click sulla mappa durante il disegno
		////////////////////////////////
		
		// Gestisce i click sulla mappa durante il disegno
		function onMapClick(e) {
			if (!isDrawing) return;
			
			const latlng = e.latlng;
			drawingPoints.push([latlng.lat, latlng.lng]);
			
			// Rimuovi tutti i marcatori temporanei esistenti per evitare conflitti visivi
			drawnItems.clearLayers();
			
			// Aggiungi tutti i punti salvati nell'array drawingPoints
			drawingPoints.forEach((point, index) => {
				const latlngPoint = L.latLng(point[0], point[1]);
				let markerColor = index === 0 ? '#dc3545' : '#0d6efd';
				let markerRadius = index === 0 ? 8 : 4;
				
				L.circleMarker(latlngPoint, {
					color: markerColor,
					fillColor: markerColor,
					fillOpacity: 0.7,
					radius: markerRadius,
					weight: 2
				}).addTo(drawnItems);
			});
			
			// Aggiungi la linea che collega i punti (preview)
			if (drawingPoints.length > 1) {
				L.polyline(drawingPoints, {
					color: '#0d6efd',
					weight: 3,
					opacity: 0.8
				}).addTo(drawnItems);
			}
			
			console.log('Punto aggiunto:', latlng);
			console.log('Totale punti:', drawingPoints.length);
			
			// Abilita "Termina" dopo 3 punti
			if (drawingPoints.length >= 3) {
				document.getElementById('finishPolygonBtn').disabled = false;
				showMapAlert(`‚úÖ ${drawingPoints.length} punti aggiunti. Clicca "Termina" per completare il poligono`, 'warning');
			} else {
				showMapAlert(`üîµ ${drawingPoints.length} punti aggiunti. Servono almeno 3 punti`, 'info');
			}
		}



		// Alert flottanti sulla mappa
		function showMapAlert(message, type) {
			// Rimuovi alert precedenti
			const existingAlerts = document.querySelectorAll('.map-alert');
			existingAlerts.forEach(alert => alert.remove());
			
			// Crea nuovo alert
			const alertDiv = document.createElement('div');
			alertDiv.className = `alert alert-${type} alert-dismissible fade show map-alert`;
			alertDiv.innerHTML = `
				${message}
				<button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
			`;
			
			// Aggiungi al container
			const mapContainer = document.getElementById('mapAlertContainer');
			if (mapContainer) {
				mapContainer.appendChild(alertDiv);
			}
			
			// Auto-rimozione dopo 5 secondi
			setTimeout(() => {
				if (alertDiv.parentNode) {
					alertDiv.remove();
				}
			}, 5000);
		}

		// Genera WKT dai punti
		function generateWKT(points) {
			// Chiudi il poligono aggiungendo il primo punto alla fine
			const closedPoints = [...points, points[0]];
			
			const wktCoords = closedPoints.map(function(point) {
				return point[1] + ' ' + point[0]; // lng lat per WKT
			}).join(', ');
			
			return 'POLYGON((' + wktCoords + '))';
		}

		// Elimina il poligono
		function deletePolygon() {
			drawnItems.clearLayers();
			currentPolygon = null;
			
			// Pulisci campi
			document.getElementById('area_geometry').value = '';
			document.getElementById('center_latitude').value = '';
			document.getElementById('center_longitude').value = '';
			
			// Aggiorna UI (RIMUOVERE riferimento a editPolygonBtn)
			// document.getElementById('editPolygonBtn').disabled = true;  // ‚Üê RIMUOVERE QUESTA RIGA
			document.getElementById('deletePolygonBtn').disabled = true;
			
			updateGeometryStatus();
			showMapAlert('üóëÔ∏è Poligono eliminato', 'info');
		}

		// Centra sulla coordinate dello scenario selezionato
		function centerOnScenario() {
			const scenarioId = document.getElementById('scenario_id').value;
			if (!scenarioId) {
				alert('Seleziona prima uno scenario!');
				return;
			}
			
			fetch('/api/scenario_coordinates/' + scenarioId)
				.then(response => response.json())
				.then(data => {
					if (data.latitude && data.longitude) {
						map.setView([data.latitude, data.longitude], 15);
						showAlert('Mappa centrata sullo scenario', 'success');
					} else {
						alert('Coordinate dello scenario non trovate');
					}
				})
				.catch(error => {
					console.error('Errore:', error);
					alert('Errore nel recupero delle coordinate');
				});
		}

		// Reset vista Italia
		function resetView() {
			map.setView([40.8518, 14.2681], 8);
		}

		// Carica geometria esistente (per modalit√† edit)
		function loadExistingGeometry() {
			const existingWKT = document.getElementById('area_geometry').value;
			
			if (existingWKT && existingWKT.trim() !== '') {
				const coords = parseWKTPolygon(existingWKT);
				
				if (coords) {
					// 1. Crea il poligono sulla mappa
					currentPolygon = L.polygon(coords, {
						color: '#0d6efd',
						weight: 3,
						opacity: 0.8,
						fillOpacity: 0.4
					}).addTo(drawnItems);
					
					// 2. Centra la mappa sul poligono
					map.fitBounds(currentPolygon.getBounds(), { padding: [20, 20] });

					// 3. CALCOLO DEL CENTRO se i campi hidden sono vuoti
					let lat = document.getElementById('center_latitude').value;
					let lng = document.getElementById('center_longitude').value;

					if (!lat || !lng || lat === "" || lng === "") {
						const center = currentPolygon.getBounds().getCenter();
						document.getElementById('center_latitude').value = center.lat.toFixed(6);
						document.getElementById('center_longitude').value = center.lng.toFixed(6);
					}
					
					// 4. Aggiorna il box informativo sotto la mappa
					updateGeometryStatus();
				}
			} else {
				updateGeometryStatus(); // Mostra "Nessuna geometria"
			}
		}

		// Aggiungi questa nuova funzione
		function parseWKTPolygon(wkt) {
			try {
				// Estrai le coordinate da "POLYGON((lng lat, lng lat, ...))"
				const coordsStr = wkt.match(/POLYGON\(\(([^)]+)\)\)/)[1];
				const pairs = coordsStr.split(',');
				
				return pairs.map(pair => {
					const [lng, lat] = pair.trim().split(' ');
					return [parseFloat(lat), parseFloat(lng)];
				}).slice(0, -1); // Rimuovi l'ultimo punto (duplicato del primo)
			} catch (e) {
				console.error('Errore parsing WKT:', e);
				return null;
			}
		}

		// Aggiorna stato geometria
		function updateGeometryStatus() {
			const geometryValue = document.getElementById('area_geometry').value;
			const statusText = document.getElementById('statusText');
			const coordsDisplay = document.getElementById('coordsDisplay');
			
			const lat = document.getElementById('center_latitude').value;
			const lng = document.getElementById('center_longitude').value;
			
			if (geometryValue && geometryValue.trim() !== '') {
				statusText.innerHTML = '<i class="fas fa-check-circle text-success"></i> Area Caricata';
				statusText.className = 'text-success fw-bold';
				
				if (lat && lng) {
					document.getElementById('displayLat').innerText = lat;
					document.getElementById('displayLng').innerText = lng;
					coordsDisplay.style.display = 'block';
				}
			} else {
				statusText.innerHTML = '<i class="fas fa-info-circle text-muted"></i> Nessuna geometria definita per questa area';
				statusText.className = 'text-muted';
				coordsDisplay.style.display = 'none';
			}
		}
		
		// Auto-genera codice area quando cambia scenario
		document.getElementById('scenario_id').addEventListener('change', function() {
			const scenarioId = this.value;
			const areaId = document.querySelector('input[name="area_id"]')?.value;
			
			if (scenarioId && !areaId) { // Solo per nuove aree
				generateAreaCode(scenarioId);
			}
		});

		// Genera il codice area
		async function generateAreaCode(scenarioId) {
			try {
				const response = await fetch(`/api/generate_area_code/${scenarioId}`);
				const data = await response.json();
				
				if (data.code) {
					document.getElementById('area_code').value = data.code;
					console.log('Codice area generato:', data.code);
				} else {
					console.error('Errore generazione codice:', data.error);
				}
			} catch (error) {
				console.error('Errore nella richiesta:', error);
			}
		}

		// Auto-genera codice se scenario gi√† selezionato (page load)
		document.addEventListener('DOMContentLoaded', function() {
			const scenarioId = document.getElementById('scenario_id').value;
			const areaId = document.querySelector('input[name="area_id"]')?.value;
			
			if (scenarioId && !areaId && !document.getElementById('area_code').value) {
				generateAreaCode(scenarioId);
			}
		});

		// Funzione alert semplice
		function showAlert(message, type) {
			const alertDiv = document.createElement('div');
			alertDiv.className = 'alert alert-' + (type || 'info') + ' alert-dismissible fade show';
			alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
			
			const container = document.querySelector('.main-content');
			if (container) {
				container.insertBefore(alertDiv, container.firstChild);
			}
			
			setTimeout(function() {
				if (alertDiv.parentNode) {
					alertDiv.remove();
				}
			}, 4000);
		}

		

		// Debug form
		function showDebugInfo() {
			const formData = {
				name: document.getElementById('name').value,
				scenario_id: document.getElementById('scenario_id').value,
				area_type: document.getElementById('area_type').value,
				reference_doc: document.getElementById('reference_doc').value,
				center_latitude: document.getElementById('center_latitude').value,
				center_longitude: document.getElementById('center_longitude').value,
				area_geometry: document.getElementById('area_geometry').value
			};
			
			console.log('=== DEBUG FORM ===', formData);
			alert('Dati form (vedi console per dettagli):\n\n' + 
				  'Nome: ' + (formData.name || 'vuoto') + '\n' +
				  'Scenario: ' + (formData.scenario_id || 'vuoto') + '\n' +
				  'Geometria: ' + (formData.area_geometry ? 'Presente (' + formData.area_geometry.length + ' caratteri)' : 'vuoto'));
		}

		// Auto-centraggio quando si cambia scenario
		document.addEventListener('DOMContentLoaded', function() {
			document.getElementById('scenario_id').addEventListener('change', function() {
				const scenarioId = this.value;
				if (scenarioId) {
					centerOnScenario();
				}
			});
		});
		
		document.addEventListener('DOMContentLoaded', function() {
		const areaTypeSelect = document.getElementById('area_type_select');
		const customContainer = document.getElementById('custom_type_container');
		const customInput = document.getElementById('custom_area_type');
		const hiddenInput = document.getElementById('final_area_type');
		
		// Gestione cambio select
		areaTypeSelect.addEventListener('change', function() {
			const selectedValue = this.value;
			
			if (selectedValue === '_custom') {
				// Mostra campo personalizzato
				customContainer.style.display = 'block';
				customInput.required = true;
				customInput.focus();
				hiddenInput.value = '';
			} else {
				// Nascondi campo personalizzato
				customContainer.style.display = 'none';
				customInput.required = false;
				customInput.value = '';
				hiddenInput.value = selectedValue;
			}
		});
		
		// Gestione input personalizzato
		customInput.addEventListener('input', function() {
			hiddenInput.value = this.value.trim();
		});
		
		// Inizializzazione per modalit√† edit
		{% if area and area.area_type %}
		const existingType = "{{ area.area_type }}";
		const selectOptions = Array.from(areaTypeSelect.options);
		const existingOption = selectOptions.find(opt => opt.value === existingType);
		
		if (!existingOption) {
			// Tipo non trovato nelle opzioni esistenti, usa input personalizzato
			areaTypeSelect.value = '_custom';
			customContainer.style.display = 'block';
			customInput.value = existingType;
			customInput.required = true;
			hiddenInput.value = existingType;
		}
		{% endif %}
		
		document.addEventListener('DOMContentLoaded', function() {
		const form = document.getElementById('areaForm');
		
		form.addEventListener('submit', async function(e) {
			e.preventDefault(); // Blocca il submit normale
			
			const isValid = await validateFormAsync();
			if (isValid) {
				// Se validazione OK, submette il form
				form.removeEventListener('submit', arguments.callee);
				form.submit(); // Submit normale
			}
		});
		
		setupLiveValidation(); // Mantieni la validazione live
	});
	});
	
	// AGGIUNGI QUESTE FUNZIONI AL JavaScript del area_form.html

	// API endpoint per verificare nome duplicato
	async function checkDuplicateName(scenarioId, name, excludeAreaId = null) {
		try {
			const url = new URL('/api/check_area_name', window.location.origin);
			url.searchParams.append('scenario_id', scenarioId);
			url.searchParams.append('name', name);
			if (excludeAreaId) {
				url.searchParams.append('exclude_area_id', excludeAreaId);
			}
			
			const response = await fetch(url);
			const data = await response.json();
			return data.exists;
		} catch (error) {
			console.error('Errore controllo nome:', error);
			return false; // In caso di errore, lascia procedere
		}
	}

	// Validazione form MIGLIORATA con controllo duplicati
	async function validateFormAsync() {
		const name = document.getElementById('name').value.trim();
		const scenarioId = document.getElementById('scenario_id').value;
		const geometry = document.getElementById('area_geometry').value.trim();
		const areaId = document.querySelector('input[name="area_id"]')?.value;
		
		// Controlli base
		if (!name) {
			alert('Il nome dell\'area √® obbligatorio');
			document.getElementById('name').focus();
			return false;
		}
		
		if (!scenarioId) {
			alert('Seleziona uno scenario');
			document.getElementById('scenario_id').focus();
			return false;
		}
		
		if (!geometry) {
			alert('Devi disegnare un poligono prima di salvare');
			return false;
		}
		
		// NUOVO: Controllo duplicati AJAX
		const submitBtn = document.querySelector('button[type="submit"]');
		const originalText = submitBtn.innerHTML;
		
		// Mostra loading
		submitBtn.disabled = true;
		submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Controllo...';
		
		try {
			const isDuplicate = await checkDuplicateName(scenarioId, name, areaId);
			
			if (isDuplicate) {
				// Ripristina pulsante
				submitBtn.disabled = false;
				submitBtn.innerHTML = originalText;
				
				// Focus sul campo nome e seleziona il testo
				const nameField = document.getElementById('name');
				nameField.focus();
				nameField.select();
				
				alert(`Esiste gi√† un'area chiamata "${name}" in questo scenario.\n\nScegli un nome diverso per continuare.`);
				return false;
			}
			
			// Se tutto OK, ripristina il pulsante e procedi
			submitBtn.disabled = false;
			submitBtn.innerHTML = originalText;
			
			console.log('Validazione completata con successo');
			return true;
			
		} catch (error) {
			// In caso di errore API, ripristina e lascia procedere
			submitBtn.disabled = false;
			submitBtn.innerHTML = originalText;
			console.error('Errore validazione:', error);
			return true;
		}
	}

	// FEEDBACK LIVE mentre l'utente scrive (opzionale)
	function setupLiveValidation() {
		const nameField = document.getElementById('name');
		const scenarioField = document.getElementById('scenario_id');
		let validationTimeout;
		
		function checkNameLive() {
			const name = nameField.value.trim();
			const scenarioId = scenarioField.value;
			const areaId = document.querySelector('input[name="area_id"]')?.value;
			
			// Clear previous timeout
			clearTimeout(validationTimeout);
			
			// Remove existing feedback
			const existingFeedback = document.getElementById('name_validation_feedback');
			if (existingFeedback) {
				existingFeedback.remove();
			}
			
			if (name.length < 3 || !scenarioId) return;
			
			// Wait 800ms before checking
			validationTimeout = setTimeout(async () => {
				try {
					const isDuplicate = await checkDuplicateName(scenarioId, name, areaId);
					
					// Create feedback element
					const feedback = document.createElement('div');
					feedback.id = 'name_validation_feedback';
					feedback.className = 'form-text mt-1';
					
					if (isDuplicate) {
						feedback.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Nome gi√† utilizzato in questo scenario';
						feedback.style.color = '#dc3545';
					} else {
						feedback.innerHTML = '<i class="fas fa-check text-success"></i> Nome disponibile';
						feedback.style.color = '#198754';
					}
					
					// Insert after the existing form-text
					const nameContainer = nameField.closest('.mb-3');
					nameContainer.appendChild(feedback);
					
				} catch (error) {
					console.error('Errore controllo live:', error);
				}
			}, 800);
		}
		
		nameField.addEventListener('input', checkNameLive);
		scenarioField.addEventListener('change', checkNameLive);
	}

	// Inizializza validazione live quando DOM √® pronto
	document.addEventListener('DOMContentLoaded', function() {
		setupLiveValidation();
	});
	
	
	</script>
	
	<!-- AGGIUNGI QUESTO ALLA FINE DEL BLOCK SCRIPTS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
	<script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

	<style>
	.leaflet-control-geocoder {
		width: 300px !important;
	}
	.leaflet-control-geocoder-form input {
		width: 250px !important;
	}

	.leaflet-control-geocoder {
		/* Rimuove il posizionamento predefinito */
		position: absolute;
		top: 0px; /* Imposta la distanza dall'alto */
		left: 50%; /* Sposta l'elemento al centro orizzontale */
		transform: translateX(20%); /* Regola per centrare correttamente */
	}
	</style>
{% endblock %}